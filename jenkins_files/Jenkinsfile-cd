pipeline{
    agent any

    environment {
        IMAGE_NAME="${params.IMAGE_VERSION}"
    }
    stages{


        stage('checkout the repo'){
            steps{
                git branch: 'main', credentialsId: 'github_cred', url: 'https://github.com/mouner0x/Advanced-DevOps-Project-Automated-CI-CD-Pipeline-on-AWS-with-Kubernetes-Jenkins-Helm-and-ArgoCD.git'
            }
        }
        stage('uppdate the image version in deployment'){
            steps{
                script{
                        sh "sed -i 's#image: .*#image: ${IMAGE_NAME}#g' helm_chart/values.yaml"
                        sh 'cat helm_chart/values.yaml'
                }
            }
        }
        stage('push the updated deployment file to github repo'){
            steps{
                script{
                    withCredentials([gitUsernamePassword(credentialsId: 'github_cred', gitToolName: 'Default')]) {
                      sh """
                         git config --global user.name mouenr0x
                         git config --global user.email mouner1@gmail.com
                         git add .
                         git commit -am "update the helm chart values file"
                         https://github.com/mouner0x/Advanced-DevOps-Project-Automated-CI-CD-Pipeline-on-AWS-with-Kubernetes-Jenkins-Helm-and-ArgoCD.git main
                        """
                     }
                }
            }
        }
    }
}
